<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GratiTree â€” Sign in</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-start: #f1fff8;
      --bg-end: #e7f3ff;
      --ink: #102a26;
      --muted: #4f6b66;
      --primary: #2a8f6b;
      --primary-hover: #197a58;
      --card-bg: rgba(255, 255, 255, 0.80);
      --glass: rgba(255, 255, 255, 0.6);
      --shadow-soft: 0 10px 40px rgba(16, 42, 38, 0.10);
      --border: 1px solid rgba(16, 42, 38, 0.10);
      --radius: 20px;
      --danger: #b42318;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      color: var(--ink);
      line-height: 1.6;
      background:
        radial-gradient(1000px 600px at 20% 0%, var(--bg-start), transparent),
        radial-gradient(1000px 600px at 80% 10%, var(--bg-end), transparent),
        linear-gradient(180deg, #fbfffd 0%, #f5fbff 100%);
      background-attachment: fixed;
      min-height: 100vh;
    }

    a { text-decoration: none; color: inherit; }

    header {
      position: fixed;
      top: 0;
      width: 100%;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      z-index: 1000;
    }

    .brand {
      font-weight: 800;
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
    }
    .brand img { width: 44px; height: auto; }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-size: 0.95rem;
      user-select: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 14px rgba(42, 143, 107, 0.30);
    }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

    .btn-ghost {
      background: rgba(255,255,255,0.85);
      color: var(--primary);
      border: 1px solid rgba(16, 42, 38, 0.10);
    }
    .btn-ghost:hover { background: #fff; }

    main {
      padding-top: 92px;
      padding-bottom: 64px;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .shell {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 24px;
      align-items: start;
      margin-top: 24px;
    }

    @media (max-width: 880px) {
      .shell { grid-template-columns: 1fr; }
      header { padding: 0 1rem; }
    }

    .card {
      background: var(--card-bg);
      border: var(--border);
      border-radius: var(--radius);
      padding: 26px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
    }

    .title {
      font-size: clamp(1.8rem, 4vw, 2.35rem);
      line-height: 1.15;
      letter-spacing: -0.02em;
      margin-bottom: 10px;
    }

    .subtitle { color: var(--muted); margin-bottom: 18px; }

    .pill {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(42, 143, 107, 0.12);
      color: var(--primary);
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 700;
      margin-bottom: 14px;
    }

    .divider { height: 1px; background: rgba(16,42,38,0.10); margin: 18px 0; }

    .user {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 12px 0 4px;
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: #c8f1e2;
      color: var(--primary);
      display: grid;
      place-items: center;
      font-weight: 800;
      overflow: hidden;
      flex: 0 0 auto;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }

    .user-meta { display: grid; }
    .user-meta strong { font-size: 0.98rem; }
    .user-meta span { font-size: 0.85rem; color: var(--muted); }

    .tree-list {
      display: grid;
      gap: 10px;
      margin-top: 14px;
    }

    .tree-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(16,42,38,0.08);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .tree-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(16, 42, 38, 0.08);
    }
    .tree-link small { color: var(--muted); font-weight: 600; }

    .hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 10px;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(180, 35, 24, 0.08);
      border: 1px solid rgba(180, 35, 24, 0.15);
      color: var(--danger);
      font-size: 0.9rem;
      display: none;
    }

    .kicker {
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }

    ul.checks { margin-top: 10px; padding-left: 18px; }
    ul.checks li { margin: 8px 0; color: var(--muted); }

    footer {
      text-align: center;
      padding: 24px 0 42px;
      color: var(--muted);
      font-size: 0.85rem;
      opacity: 0.85;
    }

    .hidden { display: none !important; }

    /* tiny google icon */
    .gmark {
      width: 18px;
      height: 18px;
      display: inline-block;
      border-radius: 4px;
      background:
        conic-gradient(from 45deg, #4285F4 0 25%, #34A853 0 50%, #FBBC05 0 75%, #EA4335 0 100%);
    }
  </style>
</head>

<body>
  <header>
    <a class="brand" href="/">
      <span><img src="/images/logo.png" alt="GratiTree logo"></span> GratiTree
    </a>
    <div class="nav-links">
      <a class="btn btn-ghost" href="/">Home</a>
      <button id="signOutTop" class="btn btn-ghost hidden" type="button">Sign out</button>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="card">
        <span class="pill">ðŸ”’ Sign in required</span>
        <h1 class="title">Welcome to your GratiTree dashboard</h1>
        <p class="subtitle">Sign in with Google to add todayâ€™s leaves and browse recent trees.</p>

        <div id="signedOutView">
          <button id="googleBtn" class="btn btn-primary" type="button">
            <span class="gmark" aria-hidden="true"></span>
            Continue with Google
          </button>
          <p class="hint">We only use your Google sign-in to identify you and protect the tree from spam.</p>
          <div class="error" id="authError"></div>
        </div>

        <div id="signedInView" class="hidden">
          <div class="user">
            <div class="avatar" id="avatar">
              <span id="initials">GT</span>
            </div>
            <div class="user-meta">
              <strong id="displayName">Signed in</strong>
              <span id="email">â€”</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="shell">
            <section class="card" style="padding: 20px;">
              <div class="kicker">Your trees</div>
              <div class="tree-list" id="treeList">
                <!-- links injected by JS -->
              </div>
              <div class="status" id="status">Ready.</div>
            </section>

            <aside class="card" style="padding: 20px;">
              <div class="kicker">How it works</div>
              <ul class="checks">
                <li>Post up to <strong>3</strong> gratitudes per day.</li>
                <li>At dayâ€™s end, that tree locks and becomes read-only.</li>
                <li>We keep the most recent <strong>6</strong> trees (today + previous 5).</li>
              </ul>
              <div class="divider"></div>
              <button id="signOut" class="btn btn-ghost" type="button">Sign out</button>
            </aside>
          </div>

          <div class="error" id="dashError"></div>
        </div>
      </div>

      <footer>Â© 2026 GratiTree â€¢ Deployed with Firebase</footer>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js';
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js';

    // Firestore is intentionally not imported until after login.

    // Paste your config from Firebase Console â†’ Project settings â†’ Your apps â†’ Web app
    const firebaseConfig = {
      apiKey: "AIzaSyAOksyrIIGh0ugEieJ1cK1B3Idl7qQyQyY",
      authDomain: "gratitree.firebaseapp.com",
      projectId: "gratitree",
      storageBucket: "gratitree.firebasestorage.app",
      messagingSenderId: "517473582832",
      appId: "1:517473582832:web:886f25ecadf981b9d48c35"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const els = {
      signedOutView: document.getElementById('signedOutView'),
      signedInView: document.getElementById('signedInView'),
      googleBtn: document.getElementById('googleBtn'),
      signOut: document.getElementById('signOut'),
      signOutTop: document.getElementById('signOutTop'),
      authError: document.getElementById('authError'),
      dashError: document.getElementById('dashError'),
      avatar: document.getElementById('avatar'),
      displayName: document.getElementById('displayName'),
      email: document.getElementById('email'),
      treeList: document.getElementById('treeList'),
      status: document.getElementById('status'),
    };

    function show(el, on = true) { el.classList.toggle('hidden', !on); }
    function setError(el, msg) {
      el.style.display = msg ? 'block' : 'none';
      el.textContent = msg || '';
    }

    // If you want a fixed timezone (e.g., Mountain Time), set TZ = 'America/Denver'.
    // Otherwise it uses the user's local timezone.
    const TZ = null; // e.g. 'America/Denver'

    function formatDayKey(d) {
      // returns YYYY-MM-DD
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: TZ || undefined,
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).formatToParts(d);
      const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return `${map.year}-${map.month}-${map.day}`;
    }

    function formatPretty(d) {
      return new Intl.DateTimeFormat('en-US', {
        timeZone: TZ || undefined,
        weekday: 'short', month: 'short', day: 'numeric'
      }).format(d);
    }

    function buildTreeLinks() {
      const now = new Date();
      const links = [];
      for (let i = 0; i < 6; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        const key = formatDayKey(d);
        links.push({
          label: i === 0 ? 'Today' : formatPretty(d),
          key,
          isToday: i === 0
        });
      }
      return links;
    }

    function renderTreeLinks() {
      const links = buildTreeLinks();
      els.treeList.innerHTML = '';

      // Assumes you have a /tree page that accepts ?day=YYYY-MM-DD
      // Change these URLs to match your actual routing.
      for (const t of links) {
        const a = document.createElement('a');
        a.className = 'tree-link';
        a.href = t.isToday
          ? `/tree/?day=${encodeURIComponent(t.key)}&mode=today`
          : `/tree/?day=${encodeURIComponent(t.key)}`;

        a.innerHTML = `
          <div>
            <div style="font-weight:800;">${t.label}</div>
            <small>${t.key}</small>
          </div>
          <div style="font-weight:800;color:var(--primary);">â†’</div>
        `;
        els.treeList.appendChild(a);
      }
    }

    async function ensureFirestoreAfterLogin() {
      // Optional: If you later want to show dashboard info pulled from Firestore,
      // lazily import Firestore ONLY after auth:
      //
      // const { getFirestore, doc, getDoc } =
      //   await import('https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js');
      // const db = getFirestore(app);
      //
      // ... fetch data here ...
    }

    els.googleBtn.addEventListener('click', async () => {
      setError(els.authError, '');
      try {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        setError(els.authError, friendlyAuthError(e));
      }
    });

    async function doSignOut() {
      setError(els.dashError, '');
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
        setError(els.dashError, 'Could not sign out. Try again.');
      }
    }

    els.signOut.addEventListener('click', doSignOut);
    els.signOutTop.addEventListener('click', doSignOut);

    function initialsFromName(nameOrEmail) {
      const s = (nameOrEmail || '').trim();
      if (!s) return 'GT';
      const parts = s.split(/\s+/).filter(Boolean);
      const init = parts.length >= 2 ? (parts[0][0] + parts[1][0]) : parts[0].slice(0,2);
      return init.toUpperCase();
    }

    function setUserUI(user) {
      els.displayName.textContent = user.displayName || 'Signed in';
      els.email.textContent = user.email || '';

      els.avatar.innerHTML = '';
      if (user.photoURL) {
        const img = document.createElement('img');
        img.alt = 'User profile photo';
        img.src = user.photoURL;
        els.avatar.appendChild(img);
      } else {
        const span = document.createElement('span');
        span.textContent = initialsFromName(user.displayName || user.email);
        els.avatar.appendChild(span);
      }
    }

    function friendlyAuthError(e) {
      const code = e?.code || '';
      if (code.includes('auth/popup-closed-by-user')) return 'Popup closed before completing sign-in.';
      if (code.includes('auth/cancelled-popup-request')) return 'Another sign-in popup is already open.';
      if (code.includes('auth/popup-blocked')) return 'Popup was blocked. Please allow popups and try again.';
      if (code.includes('auth/unauthorized-domain'))
        return 'This domain is not authorized in Firebase Auth. Add it in Firebase Console â†’ Auth â†’ Settings â†’ Authorized domains.';
      return 'Sign-in failed. Please try again.';
    }

    onAuthStateChanged(auth, async (user) => {
      setError(els.authError, '');
      setError(els.dashError, '');

      if (!user) {
        show(els.signedOutView, true);
        show(els.signedInView, false);
        show(els.signOutTop, false);
        els.status.textContent = 'Ready.';
        return;
      }

      show(els.signedOutView, false);
      show(els.signedInView, true);
      show(els.signOutTop, true);

      setUserUI(user);
      renderTreeLinks();
      els.status.textContent = 'Signed in.';

      // Lazily initialize Firestore only after authentication.
      await ensureFirestoreAfterLogin();
    });
  </script>
</body>
</html>